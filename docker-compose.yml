services:
  bakker:
    build: .
    ports:
      - "3500:3500"
    environment:
      AUTH_TOKEN: "change-me"
      ENCRYPTION_SECRET: "change-me"
      HOST: "0.0.0.0"
      PORT: "3500"
      DEV: "1"
    volumes:
      - ./server:/app/server
      - ./scripts:/app/scripts
      - ./config:/app/config
      - ./entrypoint.sh:/app/entrypoint.sh:ro
      - bakker-data:/data
    depends_on:
      db:
        condition: service_healthy

  db:
    image: mysql:8.4
    environment:
      MYSQL_DATABASE: "bakker_test"
      MYSQL_USER: "bakker"
      MYSQL_PASSWORD: "bakker_pass"
      MYSQL_ROOT_PASSWORD: "root_pass"
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "127.0.0.1",
          "-u",
          "root",
          "-proot_pass",
        ]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - mysql-data:/var/lib/mysql

volumes:
  bakker-data:
  mysql-data:
