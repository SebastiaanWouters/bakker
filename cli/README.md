# bakker

`bakker` is a shell CLI for Bakker that can:
- list backups via Bakker API
- download backups locally without importing
- import backups into configured destination databases

## Requirements

- `curl`
- `jq`
- `mysql`
- `gunzip`

## Install

One-liner install:

```bash
curl -fsSL https://raw.githubusercontent.com/SebastiaanWouters/bakker/master/install.sh | bash
```

Local repo install:

```bash
chmod +x cli/bakker
```

Release installs:

```bash
# Download from GitHub Releases, then:
chmod +x ./bakker
./bakker version
```

Optional shell alias:

```bash
alias bakker="$PWD/cli/bakker"
```

## Configuration

Config lookup order:
- `--config <path>` (if provided)
- `BAKKER_CONFIG` (if set)
- `./bakker.config.toml`
- `~/.config/bakker/bakker.config.toml`

Create a config file:

```bash
# local project config (preferred when running in a repo directory):
cp cli/config.toml.example ./bakker.config.toml

# or per-user fallback config:
mkdir -p ~/.config/bakker
cp cli/config.toml.example ~/.config/bakker/bakker.config.toml
```

Config includes all non-secret options:
- Bakker URL
- output/confirmation defaults
- optional default import profile
- destination DB profiles

Set `[defaults].profile` to avoid repeating `--profile` on every import.

For import destination passwords:
- The CLI checks, in order:
  1) env var `<PROFILE>_DB_PASS` (profile uppercased, non-alphanumeric characters converted to `_`)
  2) `password` in `[profiles.<name>]` from config
  3) interactive prompt
- Example: profile `local-dev` -> `LOCAL_DEV_DB_PASS`.

## Auth Token

- If `BAKKER_AUTH_TOKEN` is set, it is used automatically.
- If not set, the CLI prompts interactively for the token when an API call is made.

## Usage

List backups:

```bash
cli/bakker backup list
cli/bakker backup list --db prod
cli/bakker backup list --db prod --latest
cli/bakker backup list --json
```

`backup list` table output clearly shows `ID`, `NAME`, `DATE`, and `DB` (plus `SIZE`), so you can pick the exact backup for import.
IDs are generated by the Bakker server and are globally unique per Bakker instance.

Download backup only:

```bash
cli/bakker backup download 3
cli/bakker -v backup download 3
cli/bakker -vv backup download --output ./tmp/latest.sql.gz 3
cli/bakker backup download --stdout 3 > ./tmp/latest.sql.gz
```

Download verbosity:
- `-v`: heartbeat status updates
- `-vv`: heartbeat + stream percentage (when total size is known)
- `-vvv`: heartbeat + stream percentage + live throughput

Import backup:

```bash
cli/bakker backup list
cli/bakker import --profile local_dev 3
cli/bakker import -v --profile local_dev 3
cli/bakker import --skip-connectivity-check --profile local_dev 3
cli/bakker import -vvv --profile local_dev 3
cli/bakker import --profile local_dev ./Downloads/scone_preview_20260212_080001.sql.gz
```

`import` accepts either:
- a backup ID from `backup list`, or
- a local SQL dump archive (`.sql.gz`) path (relative paths are resolved from your current directory).

Imports print start/end status by default.
Use verbosity levels based on detail/perf tradeoff:
- `-v`: faster heartbeat-only updates
- `-vv`: heartbeat + stream percentage (when detectable)
- `-vvv`: heartbeat + stream percentage + current-table tracker

For ID-based imports, the CLI streams download directly into `mysql` without writing a temporary `.sql.gz` file.
Use `--skip-connectivity-check` when you want the lowest startup latency and can accept connection errors being reported later by `mysql`.

Profile commands:

```bash
cli/bakker profiles list
cli/bakker profiles show local_dev
```

Doctor:

```bash
cli/bakker doctor
```

## Global Overrides

All options can be configured in TOML and overridden by CLI flags:

```bash
cli/bakker --config /path/config.toml --api-url http://127.0.0.1:3500 backup list
cli/bakker --profile local_dev import 3
```
